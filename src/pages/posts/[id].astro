---
import { getCollection, render } from 'astro:content'
import Layout from '../../layouts/layout.astro'
import Header from '../../components/header.astro'
import ReadingProgress from '../../components/reading-progress.astro'

// 1. Generate a new path for every collection entry
export async function getStaticPaths() {
	const posts = await getCollection('posts')
	return posts.map(post => ({
		params: { id: post.id },
		props: { post },
	}))
}
// 2. For your template, you can get the entry directly from the prop
const { post } = Astro.props
const { Content, headings } = await render(post)

// Format date
const date = new Date(post.data.date)
const formattedDate = date.toLocaleDateString('en-US', {
	year: 'numeric',
	month: 'short',
	day: 'numeric',
})

const ogImage = `/open-graph/${post.id}.png`;
---

<Layout
	title={post.data.title}
	description={post.data.description || `Read ${post.data.title} on Async`}
	image={ogImage}
	type="article"
>
	<ReadingProgress />
	<Header>
		<hgroup class="flex flex-col gap-8 justify-around items-start px-4 md:px-8 max-w-3xl mx-auto">
			<a
				href="/"
				class="text-xs text-blue-600 hover:text-blue-800 transition-colors hover:underline"
			>
				&larr; Back to Home
			</a>
			<div>
				<h1
					transition:name={`title-${post.data.slug}`}
					class="font-serif text-3xl md:text-4xl text-blue-600 mb-4 text-balance"
				>
					{post.data.title}
				</h1>

				<!-- Metadata -->
				<div class="flex flex-wrap items-center gap-4 text-sm">
					<time class="text-gray-600 font-mono text-xs">{formattedDate}</time>
					{
						post.data.tags &&
							post.data.tags
								.slice(0, 3)
								.map((tag: string) => (
									<span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700">{tag}</span>
								))
					}
				</div>
			</div>
		</hgroup>
	</Header>

	<div class="relative px-4 py-6 md:px-8 md:py-12 max-w-3xl mx-auto">
		<aside class="hidden xl:block absolute top-12 bottom-12 left-full ml-10 w-64">
			<div class="sticky top-24">
				<!-- <h2 class="font-serif text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">
					On this page
				</h2> -->
				<nav class="toc relative border-l border-gray-200">
					{
						headings.map(h => (
							<a
								href={`#${h.slug}`}
								class="block text-sm text-gray-500 hover:text-blue-600 transition-colors py-1 pl-4 border-l-2 border-transparent"
								style={`margin-left: ${(h.depth - 2) * 0.5}rem`}
							>
								{h.text}
							</a>
						))
					}
				</nav>
			</div>
		</aside>

		<!-- Post Content -->
		<article
			class="prose prose-lg max-w-none
			prose-headings:font-serif prose-headings:text-blue-600 prose-headings:scroll-mt-24
			prose-h1:font-light prose-h2:font-light prose-h3:font-light prose-h4:font-light
			prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-h4:text-lg
			prose-p:text-gray-900 prose-p:leading-relaxed
			prose-a:text-blue-600 prose-a:no-underline prose-a:hover:underline
			prose-code:px-1 prose-code:py-0.5 prose-code:rounded
			prose-pre:bg-gray-50 prose-pre:border prose-pre:border-gray-200
			prose-img:rounded prose-img:shadow-sm
			prose-ul:list-disc prose-ol:list-decimal
			prose-blockquote:border-l-4 prose-blockquote:border-blue-300 prose-blockquote:pl-4 prose-blockquote:italic"
		>
			<Content />
		</article>
	</div>
</Layout>

<style>
	/* Table of Contents Marker */
	.toc {
		scroll-target-group: auto;
	}

	.toc a:target-current {
		anchor-name: --active;
		color: #2563eb;
		font-weight: 500;
	}

	.toc::after {
		content: '';
		position: absolute;
		left: -1px; /* Align with border */
		width: 2px;
		background-color: #2563eb;

		/* Anchor positioning */
		position-anchor: --active;
		top: anchor(top);
		bottom: anchor(bottom);

		/* Transition */
		transition:
			top 0.2s,
			bottom 0.2s;
	}
</style>
